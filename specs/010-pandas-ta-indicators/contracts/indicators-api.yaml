openapi: 3.0.3
info:
  title: TradingAlert Indicator API
  description: API endpoints for technical indicator calculations and metadata
  version: 1.0.0
  contact:
    name: TradingAlert Backend

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.tradingalert.example.com
    description: Production server

tags:
  - name: indicators
    description: Technical indicator operations

paths:
  /api/v1/indicators/supported:
    get:
      summary: List all supported indicators with metadata
      description: |
        Returns a list of all registered technical indicators with complete metadata.
        Each indicator includes name, description, display type, parameter definitions,
        and full rendering metadata for the frontend.
      operationId: listIndicatorsSupported
      tags:
        - indicators
      responses:
        '200':
          description: Successful response with indicator list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IndicatorInfo'
              examples:
                single_indicator:
                  summary: Single indicator (RSI)
                  value:
                    - name: "rsi"
                      description: "Relative Strength Index (period=14)"
                      display_type: "pane"
                      category: "oscillator"
                      parameters:
                        period:
                          type: "integer"
                          default: 14
                          min: 2
                          max: 200
                          description: "RSI period for calculation"
                      metadata:
                        display_type: "pane"
                        color_mode: "single"
                        color_schemes:
                          bullish: "#808080"
                          bearish: "#808080"
                          neutral: "#808080"
                        scale_ranges:
                          min: 0
                          max: 100
                          auto: false
                        series_metadata:
                          - field: "rsi"
                            role: "main"
                            label: "RSI"
                            line_color: "#808080"
                            line_style: "solid"
                            line_width: 2
                            display_type: "line"
                        reference_levels:
                          - value: 30
                            line_color: "#b2ebf2"
                            line_label: "30"
                            line_style: "dashed"
                          - value: 70
                            line_color: "#ef5350"
                            line_label: "70"
                            line_style: "dashed"
                      alert_templates: []
                multi_indicator:
                  summary: Multiple indicators
                  value:
                    - name: "rsi"
                      description: "Relative Strength Index (period=14)"
                      display_type: "pane"
                      category: "oscillator"
                      parameters:
                        period:
                          type: "integer"
                          default: 14
                          min: 2
                          max: 200
                          description: "RSI period for calculation"
                      metadata:
                        display_type: "pane"
                        color_mode: "single"
                        color_schemes:
                          bullish: "#808080"
                          bearish: "#808080"
                          neutral: "#808080"
                        scale_ranges:
                          min: 0
                          max: 100
                          auto: false
                        series_metadata:
                          - field: "rsi"
                            role: "main"
                            label: "RSI"
                            line_color: "#808080"
                            line_style: "solid"
                            line_width: 2
                            display_type: "line"
                        reference_levels:
                          - value: 30
                            line_color: "#b2ebf2"
                            line_label: "30"
                            line_style: "dashed"
                          - value: 70
                            line_color: "#ef5350"
                            line_label: "70"
                            line_style: "dashed"
                      alert_templates: []
                    - name: "macd"
                      description: "Moving Average Convergence Divergence (fast=12, slow=26, signal=9)"
                      display_type: "pane"
                      category: "momentum"
                      parameters:
                        fast:
                          type: "integer"
                          default: 12
                          min: 2
                          max: 200
                          description: "Fast period for MACD"
                        slow:
                          type: "integer"
                          default: 26
                          min: 2
                          max: 300
                          description: "Slow period for MACD"
                        signal:
                          type: "integer"
                          default: 9
                          min: 2
                          max: 100
                          description: "Signal period for MACD"
                      metadata:
                        display_type: "pane"
                        color_mode: "single"
                        color_schemes:
                          bullish: "#00bcd4"
                          bearish: "#00bcd4"
                          neutral: "#00bcd4"
                        scale_ranges:
                          min: -100
                          max: 100
                          auto: true
                        series_metadata:
                          - field: "macd"
                            role: "main"
                            label: "MACD"
                            line_color: "#00bcd4"
                            line_style: "solid"
                            line_width: 2
                            display_type: "line"
                          - field: "signal"
                            role: "signal"
                            label: "Signal"
                            line_color: "#ff9800"
                            line_style: "solid"
                            line_width: 1
                            display_type: "line"
                          - field: "histogram"
                            role: "histogram"
                            label: "Histogram"
                            line_color: "#808080"
                            line_style: "solid"
                            line_width: 2
                            display_type: "histogram"
                      alert_templates: []
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/indicators/{symbol}/{indicatorName}:
    get:
      summary: Calculate indicator for a symbol
      description: |
        Calculates the specified technical indicator for the given symbol and interval.
        Returns indicator data with timestamps, values, and rendering metadata.
      operationId: getIndicator
      tags:
        - indicators
      parameters:
        - name: symbol
          in: path
          required: true
          description: Stock ticker symbol
          schema:
            type: string
            pattern: '^[A-Z]{1,5}$'
          example: "AAPL"
        - name: indicatorName
          in: path
          required: true
          description: Indicator base name (e.g., rsi, macd, bbands, atr)
          schema:
            type: string
          example: "rsi"
        - name: interval
          in: query
          description: Candle timeframe
          required: false
          schema:
            type: string
            enum: ["1m", "5m", "15m", "1h", "4h", "1d", "1wk"]
            default: "1d"
          example: "1d"
        - name: limit
          in: query
          description: Maximum number of data points to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 10000
            default: 1000
          example: 252
        # RSI parameter
        - name: period
          in: query
          description: RSI/ATR period (for RSI and ATR indicators)
          required: false
          schema:
            type: integer
            minimum: 2
            maximum: 200
          example: 14
        # MACD parameters
        - name: fast
          in: query
          description: MACD fast period
          required: false
          schema:
            type: integer
            minimum: 2
            maximum: 200
            default: 12
          example: 12
        - name: slow
          in: query
          description: MACD slow period
          required: false
          schema:
            type: integer
            minimum: 2
            maximum: 300
            default: 26
          example: 26
        - name: signal
          in: query
          description: MACD signal period
          required: false
          schema:
            type: integer
            minimum: 2
            maximum: 100
            default: 9
          example: 9
        # BBANDS parameters
        - name: length
          in: query
          description: BBANDS period
          required: false
          schema:
            type: integer
            minimum: 2
            maximum: 500
            default: 20
          example: 20
        - name: std
          in: query
          description: BBANDS standard deviations
          required: false
          schema:
            type: number
            format: float
            minimum: 0.1
            maximum: 5.0
            default: 2.0
          example: 2.0
      responses:
        '200':
          description: Successful calculation with indicator data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndicatorOutput'
              examples:
                rsi_response:
                  summary: RSI indicator response
                  value:
                    symbol: "AAPL"
                    interval: "1d"
                    timestamps: [1609459200, 1609545600, 1609632000]
                    data:
                      rsi: [45.2, 46.1, null]
                    metadata:
                      display_type: "pane"
                      color_mode: "single"
                      color_schemes:
                        bullish: "#808080"
                        bearish: "#808080"
                        neutral: "#808080"
                      scale_ranges:
                        min: 0
                        max: 100
                        auto: false
                      series_metadata:
                        - field: "rsi"
                          role: "main"
                          label: "RSI"
                          line_color: "#808080"
                          line_style: "solid"
                          line_width: 2
                          display_type: "line"
                      reference_levels:
                        - value: 30
                          line_color: "#b2ebf2"
                          line_label: "30"
                          line_style: "dashed"
                        - value: 70
                          line_color: "#ef5350"
                          line_label: "70"
                          line_style: "dashed"
                    calculated_at: "2025-12-28T10:30:00Z"
                    data_points: 3
                macd_response:
                  summary: MACD indicator response
                  value:
                    symbol: "AAPL"
                    interval: "1d"
                    timestamps: [1609459200, 1609545600, 1609632000]
                    data:
                      macd: [1.2, 1.5, 1.3]
                      signal: [1.1, 1.3, 1.2]
                      histogram: [0.1, 0.2, 0.1]
                    metadata:
                      display_type: "pane"
                      color_mode: "single"
                      color_schemes:
                        bullish: "#00bcd4"
                        bearish: "#00bcd4"
                        neutral: "#00bcd4"
                      scale_ranges:
                        min: -100
                        max: 100
                        auto: true
                      series_metadata:
                        - field: "macd"
                          role: "main"
                          label: "MACD"
                          line_color: "#00bcd4"
                          line_style: "solid"
                          line_width: 2
                          display_type: "line"
                        - field: "signal"
                          role: "signal"
                          label: "Signal"
                          line_color: "#ff9800"
                          line_style: "solid"
                          line_width: 1
                          display_type: "line"
                        - field: "histogram"
                          role: "histogram"
                          label: "Histogram"
                          line_color: "#808080"
                          line_style: "solid"
                          line_width: 2
                          display_type: "histogram"
                    calculated_at: "2025-12-28T10:30:00Z"
                    data_points: 3
                bbands_response:
                  summary: Bollinger Bands indicator response
                  value:
                    symbol: "AAPL"
                    interval: "1d"
                    timestamps: [1609459200, 1609545600, 1609632000]
                    data:
                      upper: [112.5, 113.2, 113.8]
                      middle: [110.0, 110.5, 111.0]
                      lower: [107.5, 107.8, 108.2]
                    metadata:
                      display_type: "overlay"
                      color_mode: "single"
                      color_schemes:
                        bullish: "#2962ff"
                        bearish: "#2962ff"
                        neutral: "#2962ff"
                      series_metadata:
                        - field: "upper"
                          role: "band"
                          label: "Upper Band"
                          line_color: "#2962ff"
                          line_style: "solid"
                          line_width: 1
                          display_type: "line"
                        - field: "middle"
                          role: "band"
                          label: "Middle Band"
                          line_color: "#808080"
                          line_style: "dashed"
                          line_width: 1
                          display_type: "line"
                        - field: "lower"
                          role: "band"
                          label: "Lower Band"
                          line_color: "#2962ff"
                          line_style: "solid"
                          line_width: 1
                          display_type: "line"
                    calculated_at: "2025-12-28T10:30:00Z"
                    data_points: 3
                atr_response:
                  summary: ATR indicator response
                  value:
                    symbol: "AAPL"
                    interval: "1d"
                    timestamps: [1609459200, 1609545600, 1609632000]
                    data:
                      atr: [2.5, 2.6, 2.4]
                    metadata:
                      display_type: "pane"
                      color_mode: "single"
                      color_schemes:
                        bullish: "#ff9800"
                        bearish: "#ff9800"
                        neutral: "#ff9800"
                      scale_ranges:
                        min: 0
                        max: 50
                        auto: true
                      series_metadata:
                        - field: "atr"
                          role: "main"
                          label: "ATR"
                          line_color: "#ff9800"
                          line_style: "solid"
                          line_width: 2
                          display_type: "line"
                    calculated_at: "2025-12-28T10:30:00Z"
                    data_points: 3
        '400':
          description: Bad request (invalid parameter)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_parameter:
                  summary: Invalid parameter name
                  value:
                    detail: "Invalid parameter 'foo' for indicator 'rsi'. Valid parameters: ['period']"
                out_of_range:
                  summary: Parameter out of range
                  value:
                    detail: "Parameter 'period' must be >= 2, got 1"
                wrong_type:
                  summary: Wrong parameter type
                  value:
                    detail: "Parameter 'period' must be an integer, got string"
                invalid_interval:
                  summary: Invalid interval
                  value:
                    detail: "Invalid interval. Must be one of: 1m, 5m, 15m, 1h, 4h, 1d, 1wk"
        '404':
          description: Symbol or indicator not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                symbol_not_found:
                  summary: Symbol not found
                  value:
                    detail: "Symbol not found"
                indicator_not_found:
                  summary: Indicator not found
                  value:
                    detail: "Indicator 'foo' not found. Available: ['rsi', 'macd', 'bbands', 'atr', 'sma', 'ema', ...]"
                no_candles:
                  summary: No candles found
                  value:
                    detail: "No candles found for symbol/interval"
        '500':
          description: Calculation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                calculation_error:
                  summary: Calculation failed
                  value:
                    detail: "Error calculating indicator: insufficient data for calculation"

components:
  schemas:
    IndicatorInfo:
      type: object
      required:
        - name
        - description
        - display_type
        - category
        - metadata
      properties:
        name:
          type: string
          description: Unique indicator identifier (e.g., 'rsi', 'macd')
          example: "rsi"
        description:
          type: string
          description: Human-readable indicator description
          example: "Relative Strength Index (period=14)"
        display_type:
          type: string
          enum: ["overlay", "pane"]
          description: Whether indicator draws on price chart or separate pane
          example: "pane"
        category:
          type: string
          enum: ["overlay", "oscillator", "momentum", "trend", "volatility"]
          description: Indicator category for grouping
          example: "oscillator"
        parameters:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ParameterDefinition'
          description: Configurable parameters for this indicator
        metadata:
          $ref: '#/components/schemas/IndicatorMetadata'
          description: Full metadata for generic frontend rendering
        alert_templates:
          type: array
          items:
            $ref: '#/components/schemas/AlertTemplate'
          description: Available alert conditions
          default: []

    ParameterDefinition:
      type: object
      required:
        - type
        - default
        - description
      properties:
        type:
          type: string
          enum: ["integer", "float", "string", "boolean"]
          description: Parameter type
        default:
          description: Default value (type depends on parameter type)
        min:
          type: number
          format: float
          description: Minimum value (for numeric types)
          example: 2
        max:
          type: number
          format: float
          description: Maximum value (for numeric types)
          example: 200
        description:
          type: string
          description: Human-readable parameter description

    IndicatorOutput:
      type: object
      required:
        - symbol
        - interval
        - timestamps
        - data
        - metadata
        - calculated_at
        - data_points
      properties:
        symbol:
          type: string
          description: Stock ticker symbol
          example: "AAPL"
        interval:
          type: string
          description: Candle interval
          example: "1d"
        timestamps:
          type: array
          items:
            type: integer
            format: int64
          description: Unix timestamps in seconds (numeric, not strings)
          example: [1609459200, 1609545600, 1609632000]
        data:
          type: object
          additionalProperties:
            type: array
            items:
              type: number
              format: float
              nullable: true
          description: |
            Field name -> array of values. Use null for insufficient data.
            Field names must match metadata.series_metadata[].field values.
          example:
            rsi: [45.2, 46.1, null]
        metadata:
          $ref: '#/components/schemas/IndicatorMetadata'
        calculated_at:
          type: string
          format: date-time
          description: When calculation was performed (ISO 8601)
          example: "2025-12-28T10:30:00Z"
        data_points:
          type: integer
          description: Number of data points returned
          example: 252

    IndicatorMetadata:
      type: object
      required:
        - display_type
        - color_mode
        - color_schemes
        - series_metadata
      properties:
        display_type:
          type: string
          enum: ["overlay", "pane"]
          description: "overlay": draws on price chart; "pane": creates separate pane
        color_mode:
          type: string
          enum: ["single", "threshold", "gradient", "trend"]
          description: Color application mode
        color_schemes:
          type: object
          additionalProperties:
            type: string
            pattern: '^#[0-9A-Fa-f]{6}$'
          description: State to hex color mapping (bullish, bearish, neutral, etc.)
        thresholds:
          $ref: '#/components/schemas/ThresholdsConfig'
        scale_ranges:
          $ref: '#/components/schemas/ScaleRangesConfig'
        series_metadata:
          type: array
          items:
            $ref: '#/components/schemas/SeriesMetadata'
          description: Metadata for each visual series
        reference_levels:
          type: array
          items:
            $ref: '#/components/schemas/ReferenceLevel'
          description: Horizontal reference lines with labels
          default: []

    ThresholdsConfig:
      type: object
      required:
        - high
        - low
      properties:
        high:
          type: number
          format: float
          description: Upper threshold value
        low:
          type: number
          format: float
          description: Lower threshold value

    ScaleRangesConfig:
      type: object
      required:
        - min
        - max
        - auto
      properties:
        min:
          type: number
          format: float
          description: Minimum Y-axis value
        max:
          type: number
          format: float
          description: Maximum Y-axis value
        auto:
          type: boolean
          description: If True, auto-scale instead of using min/max

    SeriesMetadata:
      type: object
      required:
        - field
        - role
        - label
        - line_color
        - line_style
        - line_width
        - display_type
      properties:
        field:
          type: string
          description: Data field name in indicator output (CRITICAL for frontend binding)
        role:
          type: string
          enum: ["main", "signal", "band", "histogram"]
          description: Role of this series
        label:
          type: string
          description: Human-readable name for legend/UI
        line_color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          description: Hex color code
        line_style:
          type: string
          enum: ["solid", "dashed", "dotted"]
          description: Line style
        line_width:
          type: integer
          minimum: 1
          maximum: 5
          description: Line width in pixels
        display_type:
          type: string
          enum: ["line", "histogram", "area"]
          description: How to display this series

    ReferenceLevel:
      type: object
      required:
        - value
        - line_color
        - line_label
        - line_style
      properties:
        value:
          type: number
          format: float
          description: Y-axis value for the reference line
        line_color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          description: Hex color code
        line_label:
          type: string
          description: Text label shown next to the line
        line_style:
          type: string
          enum: ["solid", "dashed", "dotted"]
          description: Line style

    AlertTemplate:
      type: object
      required:
        - condition_type
        - label
        - description
        - applicable_fields
        - requires_threshold
      properties:
        condition_type:
          type: string
          description: Type of alert condition
        label:
          type: string
          description: Human-readable condition label
        description:
          type: string
          description: Condition description
        applicable_fields:
          type: array
          items:
            type: string
          description: Fields this condition applies to
        requires_threshold:
          type: boolean
          description: Whether condition requires threshold value

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message

  responses:
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            detail: "Internal server error"
