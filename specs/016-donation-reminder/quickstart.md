# Quickstart: Feedback and Donation Prompts

**Feature**: 016-donation-reminder
**Date**: 2025-01-03
**Phase**: 1 - Design

## Overview

This guide shows how to integrate and use the feedback collection and donation reminder prompt system in the TradingAlert application. The system automatically tracks usage time and displays prompts at 1 hour (feedback request) and 4 hours (donation request) of active usage.

**Key Features**:
- **1-hour prompt**: Asks users if they like the product and invites feedback
- **4-hour prompt**: Asks engaged users to support via Ko-fi
- **Feedback collection**: Message box for users to submit suggestions
- **Feedback retrieval**: Export functionality for developer analysis

---

## Installation

No new dependencies required. This feature uses existing React 19, TypeScript, and CSS modules.

---

## Quick Integration

### Step 1: Add Types

Copy `contracts/donation.types.ts` to `frontend/src/types/donation.ts`:

```bash
cp specs/016-donation-reminder/contracts/donation.types.ts frontend/src/types/donation.ts
```

### Step 2: Integrate in App Component

Wrap your main app component with the donation prompt provider:

```typescript
// frontend/src/App.tsx
import { useDonationPrompt } from './hooks/useDonationPrompt';
import { DonationPrompt } from './components/DonationPrompt';
import { FeedbackModal } from './components/FeedbackModal';

function App() {
  const {
    visiblePrompt,
    promptContent,
    dismissPrompt,
    openFeedbackForm,
    feedbackForm,
    membershipStatus,
    session
  } = useDonationPrompt();

  const handleFeedbackSubmit = (submission: FeedbackSubmission) => {
    // Feedback is automatically stored via useFeedbackStorage hook
    console.log('Feedback submitted:', submission);
  };

  return (
    <div className="app">
      {/* Your existing app content */}
      <TradingView />

      {/* Feedback modal */}
      <FeedbackModal
        isOpen={feedbackForm.isOpen}
        sessionId={session.sessionId}
        usageTimeMs={session.activeTimeMs}
        promptType={visiblePrompt || '1h'}
        onSubmit={handleFeedbackSubmit}
        onClose={() => {/* handled internally */}}
      />

      {/* Donation/Feedback prompt */}
      {promptContent && (
        <DonationPrompt
          content={promptContent}
          membershipStatus={membershipStatus}
          onDismiss={dismissPrompt}
          onAction={(action) => {
            // Handle action clicks
            if (action.action === 'feedback') {
              openFeedbackForm();
            } else if (action.url) {
              window.open(action.url, '_blank');
            }
          }}
          isVisible={visiblePrompt !== null}
        />
      )}
    </div>
  );
}
```

### Step 3: Create Components

See implementation tasks in `tasks.md` (generated by `/speckit.tasks`) for detailed component creation steps.

---

## Usage Examples

### Basic Usage

```typescript
import { useDonationPrompt } from '@/hooks/useDonationPrompt';

function MyComponent() {
  const { visiblePrompt, promptContent, dismissPrompt } = useDonationPrompt();

  // Prompt automatically appears at 1h and 4h
  // No manual trigger needed
}
```

### Custom Thresholds

```typescript
import { useDonationPrompt } from '@/hooks/useDonationPrompt';

function MyComponent() {
  const { visiblePrompt } = useDonationPrompt({
    customThresholds: {
      '1h': 30,  // Show after 30 minutes instead
      '4h': 120, // Show after 2 hours instead
    }
  });
}
```

### Manual Membership Status

```typescript
import { useDonationPrompt } from '@/hooks/useDonationPrompt';

function SettingsPanel() {
  const { membershipStatus, setMembershipStatus } = useDonationPrompt();

  return (
    <div>
      <p>Current status: {membershipStatus}</p>
      <button onClick={() => setMembershipStatus('member')}>
        I'm a member
      </button>
    </div>
  );
}
```

### Access Prompt Time Tracker

```typescript
import { useUsageTimeTracker } from '@/hooks/useUsageTimeTracker';

function UsageDisplay() {
  const { formattedTime, isIdle } = useUsageTimeTracker();

  return (
    <div>
      <p>Active time: {formattedTime}</p>
      {isIdle && <p>You're idle</p>}
    </div>
  );
}
```

### Retrieve Feedback (Developer/Admin)

```typescript
import { useFeedbackStorage } from '@/hooks/useFeedbackStorage';

function FeedbackAdmin() {
  const {
    getAllFeedback,
    exportAsJSON,
    exportAsCSV,
    count
  } = useFeedbackStorage();

  const allFeedback = getAllFeedback();

  return (
    <div>
      <h2>User Feedback ({count} submissions)</h2>
      <button onClick={() => {
        const json = exportAsJSON();
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `feedback-${Date.now()}.json`;
        a.click();
      }}>
        Export as JSON
      </button>

      <button onClick={() => {
        const csv = exportAsCSV();
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `feedback-${Date.now()}.csv`;
        a.click();
      }}>
        Export as CSV
      </button>

      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Feedback</th>
            <th>Usage Time</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody>
          {allFeedback.map(f => (
            <tr key={f.id}>
              <td>{new Date(f.timestamp).toLocaleString()}</td>
              <td>{f.feedback}</td>
              <td>{Math.floor(f.usageTimeMs / 60000)}m</td>
              <td>{f.contactEmail || '-'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

**Or access directly via localStorage** (for quick debugging):
```javascript
// In browser console:
const feedbackIds = JSON.parse(localStorage.getItem('tradingapp_feedback_index') || '[]');
const allFeedback = feedbackIds.map(id =>
  JSON.parse(localStorage.getItem(`tradingapp_feedback_${id}`))
);
console.table(allFeedback);
```

---

## Configuration

### Default Prompt Messages

Edit `frontend/src/lib/donationConfig.ts` to customize messages:

```typescript
export const PROMPT_CONTENT = {
  '1h': {
    type: '1h',
    thresholdMinutes: 60,
    message: "I see you've been using the product for a while now... Does this mean you like it? Do you want to help improve it?",
    koFiUrl: buildKoFiUrl('1h'),  // Optional secondary link
    supporterVariant: {
      message: "Thanks for being a supporter! Since you've been here for an hour...",
      actions: [
        { label: 'Share Feedback', action: 'feedback' },
        { label: 'Report a Bug', action: 'github' }
      ]
    }
  },
  '4h': {
    type: '4h',
    thresholdMinutes: 240,
    message: "Wow, you must really like the product! You've been here for 4 hours...",
    koFiUrl: buildKoFiUrl('4h'),
    supporterVariant: {
      message: "You're amazing! 4 hours of usage and you're already a supporter...",
      actions: [
        { label: 'Share Feedback', action: 'feedback' },
        { label: 'Report a Bug', action: 'github' }
      ]
    }
  }
};
```

### Adjust Idle Timeout

```typescript
import { useUsageTimeTracker } from '@/hooks/useUsageTimeTracker';

function MyComponent() {
  const tracker = useUsageTimeTracker({
    idleTimeoutMs: 15 * 60 * 1000, // 15 minutes instead of 20
  });
}
```

---

## Testing

### Manual Testing

To test prompts without waiting 1+ hours:

```typescript
// In browser console:
localStorage.setItem('tradingapp_active_time_ms', '3600000'); // 1 hour
window.dispatchEvent(new Event('storage')); // Trigger re-check

// Or set membership status:
localStorage.setItem('tradingapp_member_status', 'member');
```

### Automated Testing

```typescript
import { renderHook, act } from '@testing-library/react';
import { useDonationPrompt } from '@/hooks/useDonationPrompt';

describe('useDonationPrompt', () => {
  it('shows 1h prompt after 60 minutes', () => {
    vi.useFakeTimers();

    const { result } = renderHook(() => useDonationPrompt());

    act(() => {
      vi.advanceTimersByTime(60 * 60 * 1000); // 1 hour
    });

    expect(result.current.visiblePrompt).toBe('1h');
  });
});
```

---

## Styling

### CSS Module Structure

```css
/* DonationPrompt.module.css */
.prompt {
  position: fixed;
  bottom: 20px;
  right: 20px;
  animation: slideIn 300ms ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

### Theme Variants

```css
.prompt[data-theme="dark"] {
  background: #1a1a1a;
  color: #ffffff;
}

.prompt[data-theme="light"] {
  background: #ffffff;
  color: #000000;
}
```

---

## Accessibility

### Keyboard Navigation

- `Escape` key dismisses the prompt
- `Tab` key cycles through focusable elements
- Focus trap keeps focus within prompt when visible

### Screen Reader Support

```typescript
<DonationPrompt
  role="dialog"
  aria-labelledby="prompt-title"
  aria-describedby="prompt-message"
/>
```

---

## Troubleshooting

### Prompts Not Appearing

1. Check localStorage for `tradingapp_active_time_ms`
2. Verify idle detection isn't pausing time too aggressively
3. Check browser console for errors

### Time Resetting

- Session time resets when tab is closed (by design)
- Check for `tradingapp_session_start` in localStorage

### Styling Issues

- Ensure CSS module is imported correctly
- Check z-index conflicts with other components
- Verify responsive breakpoints for mobile

---

## File Structure Reference

```
frontend/src/
├── components/
│   ├── DonationPrompt.tsx           # Main prompt component
│   ├── DonationPrompt.module.css    # Styles
│   ├── FeedbackModal.tsx            # Feedback modal wrapper
│   ├── FeedbackForm.tsx             # Feedback form component
│   └── FeedbackModal.module.css     # Modal styles
├── hooks/
│   ├── useDonationPrompt.ts         # Prompt display logic
│   ├── useUsageTimeTracker.ts       # Time tracking logic
│   ├── useFeedbackForm.ts           # Feedback form state management
│   └── useFeedbackStorage.ts        # Feedback storage/retrieval
├── lib/
│   └── donationConfig.ts            # Configuration and content
└── types/
    └── donation.ts                  # TypeScript interfaces
```

---

## Next Steps

1. Run `/speckit.tasks` to generate implementation tasks
2. Implement components following the task list
3. Write tests for time tracking logic and feedback storage
4. Test prompts manually at different time thresholds
5. Test feedback submission and retrieval
6. Verify UTM parameters in Ko-fi dashboard

---

## Support

For issues or questions about this feature:
- Check the spec: `specs/016-donation-reminder/spec.md`
- Review the plan: `specs/016-donation-reminder/plan.md`
- See data model: `specs/016-donation-reminder/data-model.md`
