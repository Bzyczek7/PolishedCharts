# Implementation Plan: Overlay Indicator Rendering & Configuration UI

**Branch**: `008-overlay-indicator-rendering`
**Date**: 2025-12-26
**Spec**: [spec.md](./spec.md)

## Summary

Enable users to see overlay indicators rendered on the chart and customize their parameters and visual styling through a rich UI. Implements TradingView-style indicator management with hover-based context menus and a tabbed settings dialog.

**Key Change**: From calculated-but-invisible indicators → visible, interactive, customizable indicators on the chart.

## Technical Context

**Language/Version**: TypeScript 5.9 (frontend), React 19
**Primary Dependencies**: Lightweight Charts 5.1.0, Radix UI, shadcn/ui
**Storage**: Browser localStorage (no backend changes needed)
**Testing**: Vitest (React Component Testing Library)
**Target Platform**: Web browser
**Performance Goals**: Add indicator <500ms, chart redraw 60fps, max 10 indicators
**Constraints**: Feature 007 must be complete first
**Scale/Scope**: Support 5 overlay indicator types (SMA, EMA, TDFI, cRSI, ADXVMA)

## Constitution Check

### UX Parity with TradingView
- [x] Hover-based context menus (matches TradingView)
- [x] Settings dialog with tabs (matches TradingView)
- [x] Color customization per series (matches TradingView)
- [x] Hide/Show toggle (matches TradingView)
- Performance budgets: 60fps chart redraw ✅

### Correctness Over Cleverness
- [x] Parameters validated before rendering
- [x] Styles applied without breaking calculations
- [x] No data mutation during styling

### Unlimited Indicators Philosophy
- [x] No cap on indicator instances (performance-tested up to 10)
- [x] Each instance independently configurable
- [x] Each instance independently hideable/removable

### Local-First and Offline-Tolerant
- [x] Styles persisted in localStorage
- [x] Indicators render offline
- [x] No server calls for styling

### Testing and Quality Gates
- [x] Unit tests for styling and state
- [x] Integration tests for UI interactions
- [x] Performance benchmarks

### Architecture for Extensibility
- [x] IndicatorInstance schema supports future types
- [x] IndicatorStyle schema extensible
- [x] Component structure modular

**Status**: PASSED ✅

## Project Structure

### Documentation (this feature)

specs/008-overlay-indicator-rendering/
├── plan.md # This file
├── research.md # Phase 0 output
├── data-model.md # Phase 1 output
├── quickstart.md # Phase 1 output
├── tasks.md # Phase 2 output (generated by /speckit.tasks)
└── contracts/ # Phase 1 output
    └── ui-components.md # Component API specs

### Source Code (frontend only)

frontend/src/
├── components/
│   ├── OverlayIndicatorLegend.tsx # NEW: Indicator list with hover menu
│   ├── IndicatorContextMenu.tsx # NEW: Hover actions menu
│   ├── IndicatorSettingsDialog.tsx # NEW: Tabbed settings modal
│   ├── IndicatorSettingsInputs.tsx # NEW: Parameters tab
│   ├── IndicatorSettingsStyle.tsx # NEW: Color/style tab
│   ├── IndicatorSettingsVisibility.tsx # NEW: Visibility tab
│   ├── ColorPicker.tsx # NEW: Color selection
│   ├── LineStyleSelector.tsx # NEW: Line style dropdown (future)
│   ├── SourceCodeModal.tsx # NEW: Code display
│   └── ChartComponent.tsx # MODIFIED: Add series rendering (already done)
├── contexts/
│   └── IndicatorPaneContext.tsx # MODIFIED: Add instance state (or extend existing)
├── hooks/
│   ├── useIndicatorInstances.ts # NEW: localStorage persistence
│   ├── useIndicatorData.ts # UNCHANGED: Already has fetch logic
│   └── useChartSeries.ts # NEW: Chart series management
└── types/
    └── indicator.ts # MODIFIED: Add IndicatorInstance types

**Structure Decision**: Web application (frontend-only feature for overlay rendering; backend unchanged)

## Implementation Phases

### Phase 0: Research ✅ Complete

**Objective**: Understand Lightweight Charts, existing components, and UI patterns

**Key Findings**:
1. Lightweight Charts supports multiple line series with dynamic styling
2. ChartComponent already has `overlays` prop; can add series to it
3. IndicatorPaneContext exists; can extend with visibility/style state
4. localStorage available for persistence
5. No dashed line support in Lightweight Charts (solid only, initially)

**Output**: [research.md](./research.md)

### Phase 1: Design ✅ Complete

**Objective**: Define data model, UI components, and API contracts

**Deliverables**:
1. [data-model.md](./data-model.md) - IndicatorInstance, IndicatorStyle schemas
2. [contracts/ui-components.md](./contracts/ui-components.md) - Component API specs
3. [quickstart.md](./quickstart.md) - Developer guide for using indicators

**Status**: Complete

### Phase 2: Implementation ⏳ Pending

**Objective**: Build components and integrate with chart

**High-Level Tasks**:
1. Create IndicatorInstance type and localStorage hook
2. Extend ChartComponent to render overlay series
3. Build UI components (context menu, settings dialog, etc.)
4. Integrate with IndicatorPaneContext
5. Implement localStorage persistence
6. Add unit and integration tests

**Status**: Pending - Use `/speckit.tasks` to generate detailed tasks

### Phase 3: Integration Testing ⏳ Pending

**Objective**: Verify all features work together

**Checklist**:
- [ ] Add indicator → appears on chart
- [ ] Change parameter → data recalculates and chart updates
- [ ] Change color → line color updates immediately
- [ ] Hide indicator → line disappears
- [ ] Show indicator → line reappears
- [ ] Remove indicator → removed from list
- [ ] Refresh page → indicators restore from localStorage
- [ ] 10+ indicators → no lag

**Status**: Pending

## Key Design Decisions

### 1. State Location (Selected: IndicatorPaneContext Extension or New Context)

**Decision**: Create new IndicatorInstance context OR extend IndicatorPaneContext with instance visibility, styling, and localStorage

**Options Considered**:
| Option | Pros | Cons | Selected |
|--------|------|------|----------|
| Extend IndicatorPaneContext | Centralized, existing pattern | More state in one context | ✅ Yes |
| New IndicatorStyleContext | Separation of concerns | More contexts | No |
| Component local state | Simple | Hard to persist, share | No |

**Rationale**: Centralize all indicator state in one context for easier persistence and updates.

### 2. Chart Series Management (Selected: Custom Hook)

**Decision**: Create `useChartSeries` hook to manage series lifecycle

**Options Considered**:
| Option | Pros | Cons | Selected |
|--------|------|------|----------|
| useChartSeries hook | Reusable, testable | Extra file | ✅ Yes |
| Inline in ChartComponent | Simple | Hard to test | No |
| Custom series manager class | OOP style | Overkill | No |

**Rationale**: Hook pattern matches React conventions and is easier to test.

### 3. localStorage Strategy (Selected: Per-Instance + List Index)

**Decision**: Store each instance separately plus a symbol-level index

**Approach**:
- Key: `indicator_instance:${id}` → Individual instance data
- Key: `indicator_list:${symbol}` → Ordered list of instance IDs

**Why**: Allows independent instance updates without re-writing the full list.

### 4. Color Picker (Selected: HTML5 Native)

**Decision**: Use `<input type="color">` for now; add library later if needed

**Options Considered**:
| Option | Pros | Cons | Selected |
|--------|------|------|----------|
| HTML5 native | No dependencies, native feel | Limited UX | ✅ Yes |
| react-colorful | Good UX, small | Adds dependency | Future |
| react-color | Feature-rich | Large library | Future |

**Rationale**: Start simple, enhance if user feedback demands it.

### 5. Line Style (Selected: Solid Only, Extensible)

**Decision**: Implement solid lines now; add dashed/dotted via custom rendering later

**Why**: Lightweight Charts doesn't support dashed lines natively. Starting with solid is MVP.

## Dependencies

### Internal
- Existing `IndicatorPaneContext` (extends it or creates new context)
- Existing `ChartComponent` (modifies it)
- Existing `useIndicatorData` hook (reuses it)
- Feature 007 (configurable parameters) - **MUST BE COMPLETE**

### External
- `lightweight-charts`: Already in package.json (v5.1.0)
- `react`: Already in package.json (v19.2.0)
- `@radix-ui/react-dialog`: Already in package.json (v1.1.15)
- `@radix-ui/react-tabs`: Already in package.json (v1.1.13)
- `@radix-ui/react-context-menu`: Already in package.json (v2.2.16)

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| Chart redraw lag with 10+ indicators | High | Benchmark early; limit to 10 if needed |
| Complex state management | Medium | Use custom hooks; test thoroughly |
| localStorage quota exceeded | Low | Implement cleanup; warn user if limit approached |
| Lightweight Charts series limits | Low | Research max series; document limit |
| Color picker accessibility | Medium | Use Radix UI Dialog for modal; test keyboard nav |
| Parameter validation complexity | Medium | Reuse Feature 007 validation logic |

## Success Criteria

From [spec.md](./spec.md):

- **SC-001**: Overlay indicators render on chart with correct values
- **SC-002**: Context menu appears on indicator hover
- **SC-003**: Settings dialog opens and allows parameter editing
- **SC-004**: Visual changes apply immediately to chart
- **SC-005**: Hide/Show toggles visibility without removal
- **SC-006**: Source code displays with syntax highlighting
- **SC-007**: All changes persisted in localStorage
- **SC-008**: Adding indicator <500ms; chart redraws 60fps

## Open Questions

None - all clarified in research phase.

---

## Constitution Check ✅

**No violations** - Feature 008 enhances existing architecture without breaking principles.

## Timeline Estimate

- **Phase 1 (Design)**: 2-3 hours (data model, component specs) ✅ Complete
- **Phase 2 (Implementation)**: 3-4 days (components, integration)
- **Phase 3 (Testing)**: 1-2 days (unit, integration, manual)
- **Total**: ~1 week for MVP (solid lines, basic colors)

## Delivery Strategy

### MVP (Week 1)
1. ✅ Basic rendering of overlay indicators on chart (existing ChartComponent capability from Feature 007)
2. ⏳ Indicator instance management with persistence (localStorage CRUD, UUID identifiers)
3. ⏳ Context menu (Hide, Settings, Source Code, Remove)
4. ⏳ Settings dialog with Inputs/Style/Visibility tabs
5. ⏳ Basic color picker (HTML5 native) and style customization

### Phase 2+ (Future)
- Dashed/dotted line styles
- Advanced color picker library
- Indicator favorites/templates
- Alert rules based on indicator values
- Exporting indicator data

## Next Steps

1. ✅ Complete Phase 1 (data model, UI specs)
2. Generate Phase 2 tasks with `/speckit.tasks`
3. Review architecture with team
4. Start implementation
